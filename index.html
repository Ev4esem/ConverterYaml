<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel to YML Catalog Generator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5em;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e1e1;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: white;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin: 10px 0;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }
        
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .file-input-wrapper {
            position: relative;
            display: inline-block;
            width: 100%;
        }
        
        .file-input {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        .file-input-display {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            border: 2px dashed #e1e1e1;
            border-radius: 10px;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .file-input-display:hover {
            border-color: #667eea;
            background: #f0f2ff;
        }
        
        .file-icon {
            margin-right: 10px;
            font-size: 24px;
        }
        
        .output {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }
        
        .xml-output {
            background: #2d3748;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            overflow-x: auto;
            max-height: 500px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        
        .error {
            background: #fed7d7;
            color: #c53030;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }
        
        .success {
            background: #c6f6d5;
            color: #2f855a;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }
        
        .info {
            background: #bee3f8;
            color: #2c5282;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }
        
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .mapping-section {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .mapping-row {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
            padding: 10px;
            background: white;
            border-radius: 8px;
        }
        
        .preview-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .preview-table th,
        .preview-table td {
            border: 1px solid #e2e8f0;
            padding: 8px 12px;
            text-align: left;
        }
        
        .preview-table th {
            background: #f7fafc;
            font-weight: 600;
        }
        
        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
            
            .mapping-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä Excel ‚û°Ô∏è YML –ö–∞—Ç–∞–ª–æ–≥</h1>
        
        <div class="info">
            <strong>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:</strong><br>
            1. –ó–∞–≥—Ä—É–∑–∏—Ç–µ Excel —Ñ–∞–π–ª —Å —Ç–æ–≤–∞—Ä–∞–º–∏<br>
            2. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –∫–æ–ª–æ–Ω–æ–∫<br>
            3. –í–≤–µ–¥–∏—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –º–∞–≥–∞–∑–∏–Ω–µ<br>
            4. –ü–æ–ª—É—á–∏—Ç–µ –≥–æ—Ç–æ–≤—ã–π YML –∫–∞—Ç–∞–ª–æ–≥
        </div>
        
        <!-- –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ -->
        <div class="form-group">
            <label for="excelFile">üìÅ –ó–∞–≥—Ä—É–∑–∏—Ç—å Excel —Ñ–∞–π–ª:</label>
            <div class="file-input-wrapper">
                <input type="file" id="excelFile" class="file-input" accept=".xlsx,.xls" required>
                <div class="file-input-display">
                    <span class="file-icon">üìÑ</span>
                    <span>–í—ã–±–µ—Ä–∏—Ç–µ Excel —Ñ–∞–π–ª –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Å—é–¥–∞</span>
                </div>
            </div>
        </div>

        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–∞–≥–∞–∑–∏–Ω–µ -->
        <div class="mapping-section">
            <h3>üè™ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–∞–≥–∞–∑–∏–Ω–µ</h3>
            <div class="grid">
                <div class="form-group">
                    <label for="shopName">–ù–∞–∑–≤–∞–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–∞:</label>
                    <input type="text" id="shopName" value="MG parts" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –≤–∞—à–µ–≥–æ –º–∞–≥–∞–∑–∏–Ω–∞">
                </div>
                <div class="form-group">
                    <label for="shopCompany">–ö–æ–º–ø–∞–Ω–∏—è:</label>
                    <input type="text" id="shopCompany" value="MG parts" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏">
                </div>
                <div class="form-group">
                    <label for="shopUrl">URL –º–∞–≥–∞–∑–∏–Ω–∞:</label>
                    <input type="url" id="shopUrl" value="https://mgparts-shop.ru" placeholder="https://example.com">
                </div>
                <div class="form-group">
                    <label for="productUrlTemplate">–®–∞–±–ª–æ–Ω URL —Ç–æ–≤–∞—Ä–∞:</label>
                    <input type="text" id="productUrlTemplate" value="https://mgparts-shop.ru/products/{ID}" placeholder="https://example.com/products/{ID}">
                    <small style="color: #666; font-size: 12px;">–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ {ID} –¥–ª—è –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∏ ID —Ç–æ–≤–∞—Ä–∞</small>
                </div>
                <div class="form-group">
                    <label for="currencyId">–í–∞–ª—é—Ç–∞:</label>
                    <input type="text" id="currencyId" value="RUR" placeholder="RUR, USD, EUR">
                </div>
            </div>
        </div>

        <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –∫–æ–ª–æ–Ω–æ–∫ -->
        <div class="mapping-section" id="mappingSection" style="display: none;">
            <h3>üîó –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –∫–æ–ª–æ–Ω–æ–∫ Excel –∏ YML –ø–æ–ª–µ–π</h3>
            <div id="columnMapping">
                <!-- –ó–¥–µ—Å—å –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–π -->
            </div>
        </div>

        <!-- –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä –¥–∞–Ω–Ω—ã—Ö -->
        <div id="previewSection" style="display: none;">
            <h3>üëÄ –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä –¥–∞–Ω–Ω—ã—Ö</h3>
            <div class="output">
                <div id="dataStats"></div>
                <table class="preview-table" id="previewTable">
                    <!-- –ó–¥–µ—Å—å –±—É–¥–µ—Ç —Ç–∞–±–ª–∏—Ü–∞ —Å –ø—Ä–µ–≤—å—é -->
                </table>
            </div>
        </div>
        
        <button onclick="generateYML()" id="generateBtn" style="display: none;">üöÄ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å YML –∫–∞—Ç–∞–ª–æ–≥</button>
        <button onclick="downloadYML()" id="downloadBtn" style="display: none;">üíæ –°–∫–∞—á–∞—Ç—å YML —Ñ–∞–π–ª</button>
        
        <div id="output"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        let excelData = null;
        let headers = [];
        let currentYmlData = '';
        
        const ymlFields = [
            { field: 'id', label: 'ID —Ç–æ–≤–∞—Ä–∞', required: true, type: 'text' },
            { field: 'name', label: '–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞', required: true, type: 'text' },
            { field: 'price', label: '–¶–µ–Ω–∞ (Price)', required: true, type: 'number' },
            { field: 'categoryId', label: 'ID –∫–∞—Ç–µ–≥–æ—Ä–∏–∏', required: true, type: 'text' },
            { field: 'description', label: '–û–ø–∏—Å–∞–Ω–∏–µ (Description)', required: false, type: 'text' },
            { field: 'picture', label: '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (ImageUrls)', required: false, type: 'text' },
            { field: 'url', label: 'URL —Ç–æ–≤–∞—Ä–∞ (–±—É–¥–µ—Ç —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)', required: false, type: 'text' },
            { field: 'oldprice', label: '–°—Ç–∞—Ä–∞—è —Ü–µ–Ω–∞', required: false, type: 'number' },
            { field: 'available', label: '–î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å', required: false, type: 'boolean' }
        ];
        
        function handleFileSelect(event) {
            console.log('üîç handleFileSelect –≤—ã–∑–≤–∞–Ω', event);
            
            const file = event.target.files[0];
            if (!file) {
                console.log('‚ùå –§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω');
                return;
            }
            
            console.log('üìÑ –§–∞–π–ª –≤—ã–±—Ä–∞–Ω:', {
                name: file.name,
                size: file.size,
                type: file.type
            });
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ñ–∞–π–ª–∞
            const fileName = file.name.toLowerCase();
            if (!fileName.endsWith('.xlsx') && !fileName.endsWith('.xls')) {
                const error = '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ Excel —Ñ–∞–π–ª (.xlsx –∏–ª–∏ .xls)';
                console.log('‚ùå', error);
                showError(error);
                return;
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            console.log('üìÇ –ù–∞—á–∏–Ω–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É —Ñ–∞–π–ª–∞...');
            showSuccess('üìÇ –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞...');
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                console.log('üìñ –§–∞–π–ª –ø—Ä–æ—á–∏—Ç–∞–Ω, —Ä–∞–∑–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö:', e.target.result.byteLength);
                
                try {
                    const data = new Uint8Array(e.target.result);
                    console.log('üîÑ –ü–∞—Ä—Å–∏–º Excel —Ñ–∞–π–ª...');
                    
                    const workbook = XLSX.read(data, { type: 'array' });
                    console.log('üìä Workbook —Å–æ–∑–¥–∞–Ω:', workbook.SheetNames);
                    
                    // –ë–µ—Ä–µ–º –ø–µ—Ä–≤—ã–π –ª–∏—Å—Ç
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    console.log('üìã –õ–∏—Å—Ç –≤—ã–±—Ä–∞–Ω:', sheetName);
                    
                    // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ JSON
                    excelData = XLSX.utils.sheet_to_json(worksheet, { 
                        header: 1,
                        defval: ''
                    });
                    console.log('üìù –î–∞–Ω–Ω—ã–µ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã:', excelData.length, '—Å—Ç—Ä–æ–∫');
                    
                    if (excelData.length === 0) {
                        const error = '–§–∞–π–ª –ø—É—Å—Ç–æ–π –∏–ª–∏ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–∞–Ω–Ω—ã—Ö';
                        console.log('‚ùå', error);
                        showError(error);
                        return;
                    }
                    
                    headers = excelData[0] || [];
                    const dataRows = excelData.slice(1);
                    
                    console.log('‚úÖ –î–∞–Ω–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã:', { 
                        headers: headers.length, 
                        rows: dataRows.length,
                        firstRow: dataRows[0]
                    });
                    
                    showSuccess('‚úÖ –§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω —É—Å–ø–µ—à–Ω–æ! –ù–∞–π–¥–µ–Ω–æ ' + dataRows.length + ' —Å—Ç—Ä–æ–∫ –¥–∞–Ω–Ω—ã—Ö, ' + headers.length + ' –∫–æ–ª–æ–Ω–æ–∫');
                    
                    console.log('üîó –°–æ–∑–¥–∞–µ–º —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –∫–æ–ª–æ–Ω–æ–∫...');
                    createColumnMapping();
                    
                    console.log('üëÄ –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é...');
                    showPreview();
                    
                } catch (error) {
                    console.error('üí• –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
                    showError('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞: ' + error.message);
                }
            };
            
            reader.onerror = function(error) {
                console.error('üí• –û—à–∏–±–∫–∞ FileReader:', error);
                showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞');
            };
            
            console.log('üìö –ù–∞—á–∏–Ω–∞–µ–º —á—Ç–µ–Ω–∏–µ —Ñ–∞–π–ª–∞...');
            reader.readAsArrayBuffer(file);
        }
        
        function createColumnMapping() {
            const mappingDiv = document.getElementById('columnMapping');
            const mappingSection = document.getElementById('mappingSection');
            
            mappingDiv.innerHTML = '';
            
            ymlFields.forEach(function(field) {
                const row = document.createElement('div');
                row.className = 'mapping-row';
                
                const fieldLabel = document.createElement('div');
                fieldLabel.innerHTML = '<strong>' + field.label + '</strong>' + (field.required ? ' <span style="color: red;">*</span>' : '');
                
                const select = document.createElement('select');
                select.id = 'mapping_' + field.field;
                select.innerHTML = '<option value="">-- –ù–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å --</option>';
                
                headers.forEach(function(header, index) {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = header;
                    select.appendChild(option);
                });
                
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é
                const autoMatch = headers.findIndex(function(h) {
                    const headerLower = h.toLowerCase();
                    const fieldLower = field.field.toLowerCase();
                    
                    return headerLower.includes(fieldLower) ||
                        (field.field === 'id' && (headerLower.includes('–∞—Ä—Ç–∏–∫—É–ª') || headerLower.includes('–∫–æ–¥') || headerLower.includes('id'))) ||
                        (field.field === 'name' && (headerLower.includes('–Ω–∞–∑–≤–∞–Ω–∏–µ') || headerLower.includes('–Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ') || headerLower.includes('name'))) ||
                        (field.field === 'price' && (headerLower.includes('—Ü–µ–Ω–∞') || headerLower.includes('price'))) ||
                        (field.field === 'description' && (headerLower.includes('–æ–ø–∏—Å–∞–Ω–∏–µ') || headerLower.includes('description'))) ||
                        (field.field === 'picture' && (headerLower.includes('–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è') || headerLower.includes('imageurls') || headerLower.includes('picture'))) ||
                        (field.field === 'categoryId' && (headerLower.includes('–∫–∞—Ç–µ–≥–æ—Ä–∏—è') || headerLower.includes('category')));
                });
                
                if (autoMatch !== -1) {
                    select.value = autoMatch;
                }
                
                const info = document.createElement('div');
                info.style.fontSize = '12px';
                info.style.color = '#666';
                info.textContent = getFieldDescription(field.field);
                
                row.appendChild(fieldLabel);
                row.appendChild(select);
                row.appendChild(info);
                
                mappingDiv.appendChild(row);
            });
            
            mappingSection.style.display = 'block';
        }
        
        function getFieldDescription(field) {
            const descriptions = {
                'id': '–£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Ç–æ–≤–∞—Ä–∞',
                'name': '–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞',
                'price': '–¶–µ–Ω–∞ (–±—É–¥–µ—Ç —É–≤–µ–ª–∏—á–µ–Ω–∞ –Ω–∞ 10% –∏ –∫—Ä–∞—Å–∏–≤–æ –æ–∫—Ä—É–≥–ª–µ–Ω–∞)',
                'categoryId': '–ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∫–∞—Ç–µ–≥–æ—Ä–∏–∏',
                'description': '–û–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ (–Ω–∞–∑–≤–∞–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–∞ –∑–∞–º–µ–Ω–∏—Ç—Å—è –Ω–∞ MG Parts)',
                'picture': 'URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∏–∑ –ø–æ–ª—è ImageUrls (—Ä–∞–∑–¥–µ–ª–µ–Ω—ã —Å–∏–º–≤–æ–ª–æ–º |)',
                'url': '–°—Å—ã–ª–∫–∞ –Ω–∞ —Ç–æ–≤–∞—Ä (–±—É–¥–µ—Ç —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑ —à–∞–±–ª–æ–Ω–∞)',
                'oldprice': '–°—Ç–∞—Ä–∞—è —Ü–µ–Ω–∞ (–¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–∫–∏–¥–∫–∏)',
                'available': 'true/false –∏–ª–∏ 1/0'
            };
            return descriptions[field] || '';
        }
        
        function showPreview() {
            if (!excelData || excelData.length < 2) return;
            
            const previewSection = document.getElementById('previewSection');
            const dataStats = document.getElementById('dataStats');
            const previewTable = document.getElementById('previewTable');
            
            const dataRows = excelData.slice(1, 6); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–µ 5 —Å—Ç—Ä–æ–∫
            
            dataStats.innerHTML = '<strong>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</strong> –í—Å–µ–≥–æ —Å—Ç—Ä–æ–∫: ' + (excelData.length - 1) + ' | –ö–æ–ª–æ–Ω–æ–∫: ' + headers.length + ' | –ü–æ–∫–∞–∑–∞–Ω–æ: ' + Math.min(5, dataRows.length) + ' —Å—Ç—Ä–æ–∫';
            
            // –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –ø—Ä–µ–≤—å—é
            let tableHTML = '<thead><tr>';
            headers.forEach(function(header) {
                tableHTML += '<th>' + header + '</th>';
            });
            tableHTML += '</tr></thead><tbody>';
            
            dataRows.forEach(function(row) {
                tableHTML += '<tr>';
                headers.forEach(function(header, index) {
                    const cellValue = row[index] || '';
                    const cellText = String(cellValue).substring(0, 50);
                    const truncated = String(cellValue).length > 50 ? '...' : '';
                    tableHTML += '<td>' + cellText + truncated + '</td>';
                });
                tableHTML += '</tr>';
            });
            tableHTML += '</tbody>';
            
            previewTable.innerHTML = tableHTML;
            previewSection.style.display = 'block';
            document.getElementById('generateBtn').style.display = 'block';
        }
        
        function generateYML() {
            if (!excelData || excelData.length < 2) {
                showError('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏');
                return;
            }
            
            try {
                // –ü–æ–ª—É—á–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è
                const mapping = {};
                ymlFields.forEach(function(field) {
                    const select = document.getElementById('mapping_' + field.field);
                    if (select.value !== '') {
                        mapping[field.field] = parseInt(select.value);
                    }
                });
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
                const requiredFields = ymlFields.filter(function(f) { return f.required; });
                const missingRequired = requiredFields.filter(function(f) { return !(f.field in mapping); });
                
                if (missingRequired.length > 0) {
                    const missingLabels = missingRequired.map(function(f) { return f.label; }).join(', ');
                    showError('–ù–µ —É–∫–∞–∑–∞–Ω—ã –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è: ' + missingLabels);
                    return;
                }
                
                // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –º–∞–≥–∞–∑–∏–Ω–µ
                const shopInfo = {
                    name: document.getElementById('shopName').value || 'My Shop',
                    company: document.getElementById('shopCompany').value || 'My Company',
                    url: document.getElementById('shopUrl').value || 'https://example.com',
                    currency: document.getElementById('currencyId').value || 'RUR',
                    productUrlTemplate: document.getElementById('productUrlTemplate').value || 'https://example.com/products/{ID}'
                };
                
                // –°–æ–∑–¥–∞–µ–º YML –∫–∞—Ç–∞–ª–æ–≥
                const yml = createYMLCatalog(excelData.slice(1), mapping, shopInfo);
                currentYmlData = yml;
                
                showSuccess('YML –∫–∞—Ç–∞–ª–æ–≥ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!');
                displayYML(yml);
                document.getElementById('downloadBtn').style.display = 'block';
                
            } catch (error) {
                showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ YML: ' + error.message);
            }
        }
        
        function createYMLCatalog(dataRows, mapping, shopInfo) {
            const currentDate = new Date().toISOString().slice(0, 19).replace('T', ' ');
            
            let yml = '<?xml version="1.0" encoding="UTF-8"?>\n';
            yml += '<yml_catalog date="' + currentDate + '">\n';
            yml += '<shop>\n';
            yml += '<name>' + escapeXML(shopInfo.name) + '</name>\n';
            yml += '<company>' + escapeXML(shopInfo.company) + '</company>\n';
            yml += '<url>' + escapeXML(shopInfo.url) + '</url>\n';
            yml += '<currencies>\n';
            yml += '<currency id="' + shopInfo.currency + '" rate="1"/>\n';
            yml += '</currencies>\n';
            yml += '<categories>\n';

            // –°–æ–±–∏—Ä–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            const categories = [];
            dataRows.forEach(function(row) {
                if (mapping.categoryId !== undefined) {
                    const categoryId = row[mapping.categoryId];
                    if (categoryId && categories.indexOf(categoryId) === -1) {
                        categories.push(categoryId);
                    }
                }
            });
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            categories.forEach(function(categoryId) {
                yml += '<category id="' + escapeXML(categoryId) + '">' + escapeXML(categoryId) + '</category>\n';
            });
            
            yml += '</categories>\n';
            yml += '<offers>\n';

            // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–≤–∞—Ä—ã
            dataRows.forEach(function(row, index) {
                const offer = createOfferFromRow(row, mapping, index + 1, shopInfo);
                if (offer) {
                    yml += offer;
                }
            });
            
            yml += '</offers>\n';
            yml += '</shop>\n';
            yml += '</yml_catalog>';
            
            return yml;
        }
        
        function createOfferFromRow(row, mapping, defaultId, shopInfo) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
            const id = row[mapping.id] || defaultId;
            const name = row[mapping.name];
            let price = row[mapping.price];
            const categoryId = row[mapping.categoryId];
            
            if (!name || !price || !categoryId) {
                return null; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å—Ç—Ä–æ–∫–∏ –±–µ–∑ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
            }
            
            // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Ü–µ–Ω—É –Ω–∞ 10% –∏ –∫—Ä–∞—Å–∏–≤–æ –æ–∫—Ä—É–≥–ª—è–µ–º
            price = beautifyPrice(parseFloat(price) * 1.1);
            
            let offer = '\n<offer id="' + escapeXML(id) + '" available="true">';
            
            // URL —Ç–æ–≤–∞—Ä–∞ - —Ñ–æ—Ä–º–∏—Ä—É–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
            const productUrl = shopInfo.productUrlTemplate.replace('{ID}', id);
            offer += '\n<url>' + escapeXML(productUrl) + '</url>';
            
            offer += '\n<price>' + price + '</price>';
            offer += '\n<currencyId>' + shopInfo.currency + '</currencyId>';
            offer += '\n<categoryId>' + escapeXML(categoryId) + '</categoryId>';
            
            // –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∑ ImageUrls - —Ä–∞–∑–¥–µ–ª–µ–Ω—ã —Å–∏–º–≤–æ–ª–æ–º |
            if (mapping.picture !== undefined && row[mapping.picture]) {
                const pictureData = String(row[mapping.picture]);
                // –†–∞–∑–¥–µ–ª—è–µ–º –ø–æ —Å–∏–º–≤–æ–ª—É | –∏ —É–¥–∞–ª—è–µ–º –ø—É—Å—Ç—ã–µ
                const pictures = pictureData.split('|');
                pictures.forEach(function(pic) {
                    const trimmedPic = pic.trim();
                    if (trimmedPic) {
                        offer += '\n<picture>' + escapeXML(trimmedPic) + '</picture>';
                    }
                });
            }
            
            offer += '\n<name>' + escapeXML(name) + '</name>';
            
            // –û–ø–∏—Å–∞–Ω–∏–µ —Å –∑–∞–º–µ–Ω–æ–π –Ω–∞–∑–≤–∞–Ω–∏—è –º–∞–≥–∞–∑–∏–Ω–∞
            if (mapping.description !== undefined && row[mapping.description]) {
                let description = String(row[mapping.description]);
                // –ó–∞–º–µ–Ω—è–µ–º —Ä–∞–∑–ª–∏—á–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –Ω–∞–∑–≤–∞–Ω–∏–π –º–∞–≥–∞–∑–∏–Ω–æ–≤ –Ω–∞ "MG Parts"
                description = description
                    .replace(/\b[A-Za-z–ê-–Ø–∞-—è0-9\s\-\.]+\s*(parts?|–∑–∞–ø—á–∞—Å—Ç–∏|–º–∞–≥–∞–∑–∏–Ω|shop|store)\b/gi, 'MG Parts')
                    .replace(/\b(–Ω–∞—à|–Ω–∞—à–∞|–Ω–∞—à–µ–≥–æ|–Ω–∞—à–µ–π)\s+(–º–∞–≥–∞–∑–∏–Ω|–∫–æ–º–ø–∞–Ω–∏—è|–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è|—Ñ–∏—Ä–º–∞)\b/gi, 'MG Parts')
                    .replace(/\b(–≤|—É)\s+–Ω–∞—Å\b/gi, '—É MG Parts')
                    .replace(/\b–º—ã\s+(–ø—Ä–µ–¥–ª–∞–≥–∞–µ–º|–ø—Ä–æ–¥–∞–µ–º|—Ä–µ–∞–ª–∏–∑—É–µ–º)\b/gi, 'MG Parts –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç');
                
                offer += '\n<description>' + escapeXML(description) + '</description>';
            }
            
            // –°—Ç–∞—Ä–∞—è —Ü–µ–Ω–∞
            if (mapping.oldprice !== undefined && row[mapping.oldprice]) {
                let oldPrice = beautifyPrice(parseFloat(row[mapping.oldprice]) * 1.1);
                offer += '\n<oldprice>' + oldPrice + '</oldprice>';
            }
            
            offer += '\n</offer>';
            
            return offer;
        }
        
        function beautifyPrice(price) {
            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–≥–æ –æ–∫—Ä—É–≥–ª–µ–Ω–∏—è —Ü–µ–Ω
            if (price <= 0) return 0;
            
            // –ï—Å–ª–∏ —Ü–µ–Ω–∞ –º–µ–Ω—å—à–µ 100 - –æ–∫—Ä—É–≥–ª—è–µ–º –¥–æ 10
            if (price < 100) {
                return Math.round(price / 10) * 10;
            }
            
            // –ï—Å–ª–∏ —Ü–µ–Ω–∞ –º–µ–Ω—å—à–µ 1000 - –æ–∫—Ä—É–≥–ª—è–µ–º –¥–æ 50
            if (price < 1000) {
                return Math.round(price / 50) * 50;
            }
            
            // –ï—Å–ª–∏ —Ü–µ–Ω–∞ –º–µ–Ω—å—à–µ 5000 - –æ–∫—Ä—É–≥–ª—è–µ–º –¥–æ 100
            if (price < 5000) {
                return Math.round(price / 100) * 100;
            }
            
            // –ï—Å–ª–∏ —Ü–µ–Ω–∞ –º–µ–Ω—å—à–µ 10000 - –æ–∫—Ä—É–≥–ª—è–µ–º –¥–æ 250
            if (price < 10000) {
                return Math.round(price / 250) * 250;
            }
            
            // –ï—Å–ª–∏ —Ü–µ–Ω–∞ –º–µ–Ω—å—à–µ 50000 - –æ–∫—Ä—É–≥–ª—è–µ–º –¥–æ 500
            if (price < 50000) {
                return Math.round(price / 500) * 500;
            }
            
            // –î–ª—è –±–æ–ª—å—à–∏—Ö —Ü–µ–Ω - –æ–∫—Ä—É–≥–ª—è–µ–º –¥–æ 1000
            return Math.round(price / 1000) * 1000;
        }
        
        function escapeXML(str) {
            if (str === null || str === undefined) return '';
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }
        
        function displayYML(ymlData) {
            const outputDiv = document.getElementById('output');
            outputDiv.innerHTML = '<div class="output"><h3>üìÑ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π YML –∫–∞—Ç–∞–ª–æ–≥:</h3><div class="xml-output">' + escapeHTML(ymlData) + '</div></div>';
        }
        
